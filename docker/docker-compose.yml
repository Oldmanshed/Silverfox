version: '3.8'

services:
  api:
    build:
      context: ../
      dockerfile: docker/Dockerfile.api
    container_name: silverfox-api
    environment:
      - OPENCLAW_URL=${OPENCLAW_URL:-http://host.docker.internal:8080}
      - SESSION_KEY=${SESSION_KEY:-agent:main:main}
      - DATABASE_URL=/data/silverfox.db
      - PORT=3456
      - NODE_ENV=production
      - WS_CORS_ORIGIN=*
    volumes:
      - ./data:/data
    networks:
      - silverfox
    restart: unless-stopped
    # Allow access to host services (OpenClaw gateway)
    extra_hosts:
      - "host.docker.internal:host-gateway"

  web:
    build:
      context: ../
      dockerfile: docker/Dockerfile.web
    container_name: silverfox-web
    depends_on:
      - api
    networks:
      - silverfox
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: silverfox-nginx
    ports:
      - "${SILVERFOX_PORT:-3003}:80"
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      - api
    networks:
      - silverfox
    restart: unless-stopped

networks:
  silverfox:
    name: silverfox
